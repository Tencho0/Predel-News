@using Microsoft.AspNetCore.Http.Extensions
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<ArticleViewModel>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var article = Model.Article;
}

@section Styles {
    <style>
        .article-content img { max-width: 100%; height: auto; }
        .article-content p { margin-bottom: 1.5rem; }
        .article-content h2, .article-content h3 { margin-top: 2rem; margin-bottom: 1rem; }
    </style>
}

<article class="article-page" itemscope itemtype="https://schema.org/NewsArticle">
    <meta itemprop="mainEntityOfPage" content="@article.GetUrl()" />

    <header class="article-header">
        <div class="article-meta-top">
            <a href="@article.Category.GetUrl()" class="article-category-link" itemprop="articleSection">
                @article.Category.Name
            </a>
            @if (article.IsBreakingNews)
            {
                <span class="badge badge-breaking">Breaking</span>
            }
        </div>

        <h1 class="article-title" itemprop="headline">@article.Title</h1>

        @if (!string.IsNullOrEmpty(article.Subtitle))
        {
            <p class="article-subtitle">@article.Subtitle</p>
        }

        <div class="article-meta">
            <div class="article-author" itemprop="author" itemscope itemtype="https://schema.org/Person">
                @if (article.Author.Avatar != null)
                {
                    <img src="@article.Author.Avatar.GetCropUrl(40, 40)"
                         alt="@article.Author.Name"
                         class="author-avatar"
                         width="40"
                         height="40" />
                }
                <div class="author-info">
                    <a href="@article.Author.GetUrl()" class="author-name" itemprop="name">@article.Author.Name</a>
                    <time datetime="@article.PublishDate.ToString("yyyy-MM-ddTHH:mm:ss")" itemprop="datePublished" class="article-date">
                        @article.PublishDate.ToString("d MMMM yyyy, HH:mm", new System.Globalization.CultureInfo("bg-BG"))
                    </time>
                </div>
            </div>

            <div class="article-share">
                <span class="share-label">Share:</span>
                <a href="https://www.facebook.com/sharer/sharer.php?u=@Uri.EscapeDataString(Context.Request.GetDisplayUrl())"
                   class="share-link share-facebook"
                   target="_blank"
                   rel="noopener noreferrer"
                   aria-label="Share on Facebook">
                    <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
                    </svg>
                </a>
                <a href="https://twitter.com/intent/tweet?url=@Uri.EscapeDataString(Context.Request.GetDisplayUrl())&text=@Uri.EscapeDataString(article.Title)"
                   class="share-link share-twitter"
                   target="_blank"
                   rel="noopener noreferrer"
                   aria-label="Share on Twitter">
                    <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
                    </svg>
                </a>
            </div>
        </div>
    </header>

    @if (article.FeaturedImage != null)
    {
        <figure class="article-featured-image" itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
            <img src="@article.FeaturedImage.GetResizeUrl(1200)"
                 alt="@(article.FeaturedImage.AltText ?? article.Title)"
                 itemprop="url"
                 loading="eager" />
            <meta itemprop="width" content="@article.FeaturedImage.Width" />
            <meta itemprop="height" content="@article.FeaturedImage.Height" />
        </figure>
    }

    @await Html.PartialAsync("Partials/_AdSlot", new { Position = "article-before-content", Size = "728x90" })

    <div class="article-content" itemprop="articleBody">
        @Html.Raw(article.Content)
    </div>

    @if (article.Tags?.Any() == true)
    {
        <footer class="article-footer">
            <div class="article-tags">
                <span class="tags-label">Tags:</span>
                <ul class="tags-list">
                    @foreach (var tag in article.Tags)
                    {
                        <li class="tag-item">
                            <a href="@tag.GetUrl()" class="tag-link">@tag.Name</a>
                        </li>
                    }
                </ul>
            </div>
        </footer>
    }

    @await Html.PartialAsync("Partials/_AdSlot", new { Position = "article-after-content", Size = "728x90" })

    <div class="article-author-box">
        <h3 class="author-box-title">About the Author</h3>
        <div class="author-box-content">
            @if (article.Author.Avatar != null)
            {
                <img src="@article.Author.Avatar.GetCropUrl(80, 80)"
                     alt="@article.Author.Name"
                     class="author-box-avatar"
                     width="80"
                     height="80" />
            }
            <div class="author-box-info">
                <a href="@article.Author.GetUrl()" class="author-box-name">@article.Author.Name</a>
                @if (!string.IsNullOrEmpty(article.Author.Bio))
                {
                    <p class="author-box-bio">@article.Author.Bio</p>
                }
                <div class="author-box-social">
                    @if (!string.IsNullOrEmpty(article.Author.TwitterHandle))
                    {
                        <a href="https://twitter.com/@article.Author.TwitterHandle" class="social-link" target="_blank" rel="noopener noreferrer" aria-label="Twitter">
                            <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
                            </svg>
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (Model.RelatedArticles?.Any() == true)
    {
        <section class="related-articles">
            <h3 class="related-title">Related Articles</h3>
            <div class="related-grid">
                @foreach (var related in Model.RelatedArticles)
                {
                    <article class="related-card">
                        <a href="@related.GetUrl()" class="related-card-link">
                            @if (related.FeaturedImage != null)
                            {
                                <figure class="related-card-image">
                                    <img src="@related.FeaturedImage.GetCropUrl(300, 200)"
                                         alt="@(related.FeaturedImage.AltText ?? related.Title)"
                                         width="300"
                                         height="200"
                                         loading="lazy" />
                                </figure>
                            }
                            <h4 class="related-card-title">@related.Title</h4>
                            <time datetime="@related.PublishDate.ToString("yyyy-MM-ddTHH:mm:ss")" class="related-card-date">
                                @related.PublishDate.ToString("d MMM yyyy", new System.Globalization.CultureInfo("bg-BG"))
                            </time>
                        </a>
                    </article>
                }
            </div>
        </section>
    }

    @if (Model.PreviousArticle != null || Model.NextArticle != null)
    {
        <nav class="article-navigation" aria-label="Article navigation">
            <div class="nav-previous">
                @if (Model.PreviousArticle != null)
                {
                    <a href="@Model.PreviousArticle.GetUrl()" class="nav-link">
                        <span class="nav-label">Previous</span>
                        <span class="nav-title">@Model.PreviousArticle.Title</span>
                    </a>
                }
            </div>
            <div class="nav-next">
                @if (Model.NextArticle != null)
                {
                    <a href="@Model.NextArticle.GetUrl()" class="nav-link">
                        <span class="nav-label">Next</span>
                        <span class="nav-title">@Model.NextArticle.Title</span>
                    </a>
                }
            </div>
        </nav>
    }
</article>

@section Scripts {
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "NewsArticle",
        "headline": "@Html.Raw(System.Text.Json.JsonEncodedText.Encode(article.Title))",
        "description": "@Html.Raw(System.Text.Json.JsonEncodedText.Encode(article.Excerpt ?? ""))",
        "image": "@(article.FeaturedImage?.Url ?? "")",
        "author": {
            "@@type": "Person",
            "name": "@article.Author.Name",
            "url": "@article.Author.GetUrl()"
        },
        "publisher": {
            "@@type": "Organization",
            "name": "Predel News",
            "logo": {
                "@@type": "ImageObject",
                "url": "/images/logo.png"
            }
        },
        "datePublished": "@article.PublishDate.ToString("yyyy-MM-ddTHH:mm:ssZ")",
        "dateModified": "@(article.UpdatedDate?.ToString("yyyy-MM-ddTHH:mm:ssZ") ?? article.PublishDate.ToString("yyyy-MM-ddTHH:mm:ssZ"))",
        "mainEntityOfPage": {
            "@@type": "WebPage",
            "@@id": "@article.GetUrl()"
        },
        "articleSection": "@article.Category.Name"
    }
    </script>
}
